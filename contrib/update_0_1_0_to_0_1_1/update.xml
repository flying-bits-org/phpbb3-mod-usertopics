<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD. Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.0.xsd">
  <header>
    <license>http://opensource.org/licenses/gpl-license.php GNU General Public License v2</license>
    <title lang="en-gb">user topics MOD</title>
    <title lang="de">user topics MOD</title>
    <description lang="en-gb">Adds the number of opened user-topics to the number of user-posts on all pages.</description>
    <description lang="de">Fügt die Anzahl der vom Benutzer eröffneten Themen zu der, der Beiträge in sämtlichen Dateien hinzu.</description>
    <author-notes lang="en-gb">i hope you get it installed, otherwise you can ask for help on phpbb.de and phpbb.com</author-notes>
    <author-notes lang="de">Ich hoffe ihr kommt mit dem MOD klar. Wenn nicht, könnt ihr auf phpbb.de oder phpbb.com eure Fragen stellen.</author-notes>
    <author-group>
      <author>
        <realname>Joas Schilling</realname>
        <email>nickvergessen@gmx.de</email>
        <username>nickvergessen</username>
        <homepage>http://www.flying-bits.org/</homepage>
        <contributions />
      </author>
    </author-group>
    <mod-version>0.1.1</mod-version>
    <installation>
      <level>intermediate</level>
      <time>900</time>
      <target-version>3.0.1</target-version>
    </installation>
    <meta name="generator" content="Phpbb.ModTeam.Tools (c#)" />
  </header>
  <action-group>
    <open src="adm/style/acp_main.html">
      <edit>
        <find><![CDATA[			<form id="action_user_form" method="post" action="{U_ACTION}">
				<dl>
					<dt><label for="action_user">{L_RESYNC_POSTCOUNTS}</label><br /><span>{L_RESYNC_POSTCOUNTS_EXPLAIN}</span></dt>
					<dd><input type="hidden" name="action" value="user" /><input class="button2" type="submit" id="action_user" name="action_user" value="{L_RUN}" /></dd>
				</dl>
			</form>]]></find>
        <action type="after-add"><![CDATA[			<form id="action_topics_form" method="post" action="{U_ACTION}">
				<dl>
					<dt><label for="action_topics">{L_RESYNC_TOPICCOUNTS}</label><br /><span>{L_RESYNC_TOPICCOUNTS_EXPLAIN}</span></dt>
					<dd><input type="hidden" name="action" value="topics" /><input class="button2" type="submit" id="action_topics" name="action_topics" value="{L_RUN}" /></dd>
				</dl>
			</form>]]></action>
      </edit>
    </open>
    <open src="memberlist.php">
      <edit>
        <find><![CDATA['U_SEARCH_USER_TOPICS'	=> ($auth->acl_get('u_search')) ? append_sid("{$phpbb_root_path}search.$phpEx", "author_id=$user_id&amp;sr=topics") : '',]]></find>
        <action type="replace-with"><![CDATA['U_SEARCH_USER_TOPICS'	=> ($auth->acl_get('u_search')) ? append_sid("{$phpbb_root_path}search.$phpEx", "author_id=$user_id&amp;sr=topics&amp;sf=firstpost") : '',]]></action>
      </edit>
    </open>
    <open src="includes/acp/acp_main.php">
      <edit>
        <find><![CDATA[					case 'user':
						$confirm = true;
						$confirm_lang = 'RESYNC_POSTCOUNTS_CONFIRM';
					break;]]></find>
        <action type="after-add"><![CDATA[					case 'topics':
						$confirm = true;
						$confirm_lang = 'RESYNC_TOPICCOUNTS_CONFIRM';
					break;]]></action>
      </edit>
      <edit>
        <find><![CDATA[						$sql = 'SELECT COUNT(t.topic_id) AS num_topics, u.user_id
							FROM ' . USERS_TABLE . ' u
							LEFT JOIN  ' . TOPICS_TABLE . ' t ON (u.user_id = t.topic_poster)
							LEFT JOIN  ' . POSTS_TABLE . ' p ON (t.topic_first_post_id = p.post_id AND p.post_postcount = 1)
							GROUP BY u.user_id';
						$result = $db->sql_query($sql);

						while ($row = $db->sql_fetchrow($result))
						{
							$db->sql_query('UPDATE ' . USERS_TABLE . " SET user_topics = {$row['num_topics']} WHERE user_id = {$row['user_id']}");
						}
						$db->sql_freeresult($result);
]]></find>
        <action type="replace-with"><![CDATA[]]></action>
      </edit>
      <edit>
        <find><![CDATA[						add_log('admin', 'LOG_RESYNC_POSTCOUNTS');

					break;]]></find>
        <action type="after-add"><![CDATA[					case 'topics':
						if (!$auth->acl_get('a_board'))
						{
							trigger_error($user->lang['NO_AUTH_OPERATION'] . adm_back_link($this->u_action), E_USER_WARNING);
						}

						$sql = 'SELECT COUNT(p.post_id) AS num_topics, u.user_id
							FROM ' . USERS_TABLE . ' u
							LEFT JOIN  ' . TOPICS_TABLE . ' t ON (u.user_id = t.topic_poster)
							LEFT JOIN  ' . POSTS_TABLE . ' p ON (p.post_id = t.topic_first_post_id AND p.post_postcount = 1)
							GROUP BY u.user_id';
						$result = $db->sql_query($sql);

						while ($row = $db->sql_fetchrow($result))
						{
							$db->sql_query('UPDATE ' . USERS_TABLE . " SET user_topics = {$row['num_topics']} WHERE user_id = {$row['user_id']}");
						}
						$db->sql_freeresult($result);

						add_log('admin', 'LOG_RESYNC_TOPICCOUNTS');

					break;]]></action>
      </edit>
    </open>
    <open src="includes/ucp/ucp_main.php">
      <edit>
        <find><![CDATA['U_SEARCH_USER_TOPICS'	=> ($auth->acl_get('u_search')) ? append_sid("{$phpbb_root_path}search.$phpEx", 'author_id=' . $user->data['user_id'] . '&amp;sr=topics') : '',]]></find>
        <action type="replace-with"><![CDATA['U_SEARCH_USER_TOPICS'	=> ($auth->acl_get('u_search')) ? append_sid("{$phpbb_root_path}search.$phpEx", 'author_id=' . $user->data['user_id'] . '&amp;sr=topics&amp;sf=firstpost') : '',]]></action>
      </edit>
    </open>
    <open src="language/en/acp/common.php">
      <edit>
        <find><![CDATA[	'RESYNC_STATS_CONFIRM'			=> 'Are you sure you wish to resynchronise statistics?',
	'RESYNC_STATS_EXPLAIN'			=> 'Recalculates the total number of posts, topics, users and files.',]]></find>
        <action type="after-add"><![CDATA[	'RESYNC_TOPICCOUNTS'			=> 'Resynchronise topic counts',
	'RESYNC_TOPICCOUNTS_EXPLAIN'	=> 'Only existing topics will be taken into consideration. Pruned topics will not be counted.',
	'RESYNC_TOPICCOUNTS_CONFIRM'	=> 'Are you sure you wish to resynchronise topic counts?',]]></action>
      </edit>
      <edit>
        <find><![CDATA['LOG_RESYNC_STATS'			=> '<strong>Post, topic and user statistics resynchronised</strong>',]]></find>
        <action type="after-add"><![CDATA['LOG_RESYNC_TOPICCOUNTS'	=> '<strong>User topic counts resynchronised</strong>',]]></action>
      </edit>
    </open>
  </action-group>
</mod>